import"./main.DZhyD6Ys.js";import"./eox-map-advanced-layers-and-sources.BOcgYJqI.js";import{q as g,d as M,e as L,r as R,t as U,l as b,f as J,v as W,k as Z,w as K,E as Q}from"./eo-dash.BIm2sYY-.js";import{p as C,h as S,v as j,c as X,j as A,x as T,q as Y,o as $}from"./framework.CxY9FQpQ.js";import"./lit-element.Cu4xVypU.js";import"./commonjsHelpers.Cpj98o6Y.js";import"./theme.YAEQg5us.js";let w=null;const m=(e,u)=>{const n=r=>{var o;const s=r.map,l=(o=e.value)==null?void 0:o.lonLatCenter,i=s==null?void 0:s.getView().getZoom();l&&!Number.isNaN(l[0])&&!Number.isNaN(l[1])&&!Number.isNaN(i)&&(u.value=[l[0],l[1],i])};j(()=>{var r,s;(s=(r=e.value)==null?void 0:r.map)==null||s.on("moveend",n)}),T(()=>{var r,s;(s=(r=e.value)==null?void 0:r.map)==null||s.un("moveend",n)})},P=async(e,u,n)=>{b.debug("Creating layers config",e,u,n);const r=[],s={type:"Group",properties:{id:"AnalysisGroup",title:"Analysis Layers",layerControlExpand:!0},layers:[]};for(const t of u){let c;n?c=await t.createLayersJson(new Date(n)):c=await t.createLayersJson(),c.forEach(a=>{a.properties.layerControlExpand=!0,a.properties.layerControlToolsExpand=!0}),s.layers.push(...c)}r.push(s);const l=await Q.getIndicatorLayers(e),i={type:"Group",properties:{id:"BaseLayersGroup",title:"Base Layers"},layers:[]},o=l.filter(t=>t.properties.group==="baselayer");if(o.length){let t=0,c=0;for(let a=0;a<o.length;a++){const y=o[a];"visible"in y.properties||(y.properties.visible=!1),y.properties.visible&&(t++,c=a)}t===0&&(o[0].properties.visible=!0),t>0&&o.forEach((a,y)=>{y!==c?a.properties.visible=!1:a.properties.visible=!0}),i.layers.push(...o),i.layers.forEach(a=>{a.properties.layerControlExclusive=!0})}else i.layers.push({type:"Tile",properties:{id:"osm",title:"Background",layerControlExclusive:!0},source:{type:"OSM"}});i.layers.length&&r.push(i);const f={type:"Group",properties:{id:"OverlayGroup",title:"Overlay Layers"},layers:[]},p=l.filter(t=>t.properties.group==="overlay");return p.length&&(f.layers.push(...p),r.unshift(f)),r},V=(e,u,n,r,s,l)=>{b.debug("InitMap",e.value,u.value,n.values,r.value);const i=Y([u,r],async([o,f],[p,t])=>{var c,a,y,N,_,O,B,k,G,I,z;if(o){b.debug("Selected Indicator watch triggered",o,f),((c=e==null?void 0:e.value)==null?void 0:c.id)==="main"&&w!==null&&((a=e==null?void 0:e.value)==null||a.map.setView(w),w=null);let h=[];const q=(o==null?void 0:o.id)===(p==null?void 0:p.id)&&f!==t,{selectedCompareStac:D}=M(L());if(((y=e==null?void 0:e.value)==null?void 0:y.id)==="main"?await K(o):D.value!==null&&(w=(N=e==null?void 0:e.value)==null?void 0:N.map.getView(),e.value.sync=l.value),q){h=await P(o,n,f),b.debug("Assigned layers after changing time only",JSON.parse(JSON.stringify(h))),s.value=h;return}h=await P(o,n,r.value);let d=null;const x=(O=(_=o==null?void 0:o.extent)==null?void 0:_.temporal)==null?void 0:O.interval;if(x&&x.length>0&&x[0].length>1&&(d=new Date(x[0][1]),b.debug("Indicator load: found stac extent, setting time to latest value",d)),d!==null&&d.toISOString()!==r.value&&(r.value=d.toISOString()),((B=e==null?void 0:e.value)==null?void 0:B.id)==="main"){const v=(k=o.extent)==null?void 0:k.spatial.bbox[0],H=[v[0]>-180?v[0]:-180,v[1]>-90?v[1]:-90,v[2]<180?v[2]:180,v[3]<90?v[3]:90],F=(z=e.value)==null?void 0:z.transformExtent(H,"EPSG:4326",(I=(G=e.value)==null?void 0:G.map)==null?void 0:I.getView().getProjection());e.value.zoomExtent=F}b.debug("Assigned layers",JSON.parse(JSON.stringify(h))),s.value=h}},{immediate:!0});T(()=>{i()})},E=[".enabled"],ee=[".layers"],oe=[".layers"],ce={__name:"EodashMap",props:{enableCompare:{type:Boolean,default:!1}},setup(e){var t;const u=e,n=C([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),r=C([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),s=C(null),l=C(null),i={center:[15,48],zoom:4},o={center:[15,48],zoom:4};g&&g.value&&g.value.length===3&&(i.center=[(t=g.value)==null?void 0:t[0],g.value[1]],i.zoom=g.value[2]);const{selectedCompareStac:f}=M(L()),p=S(()=>u.enableCompare&&f.value?"":"first");return m(s,g),j(()=>{const{selectedCompareStac:c,selectedStac:a}=M(L());R.value=s.value,u.enableCompare&&(U.value=l.value),u.enableCompare&&V(l,c,W,J,r,s),V(s,a,Z,J,n,l)}),(c,a)=>($(),X("eox-map-compare",{class:"fill-height fill-width overflow-none",".enabled":p.value},[A("eox-map",{class:"fill-height fill-width overflow-none",slot:"first",ref_key:"eoxMap",ref:s,".config":i,id:"main",".layers":n.value},null,40,ee),A("eox-map",{class:"fill-height fill-width overflow-none",id:"compare",slot:"second",ref_key:"compareMap",ref:l,".config":o,".layers":r.value},null,40,oe)],40,E))}};export{ce as default};
